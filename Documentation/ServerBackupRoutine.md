# Server Backup Routine

Server is backed up every friday night around 12:00 AM.

During the backup process, the server is down and the following files are generated by perforce:

```checkpoint``` 

```journal```

These files stores the state of the server so far, and are essentail for the recorvery.

The backup routine then copies the ```checkpoint``` and the ```journal``` file, as well as all the important files in the perforce root directory to a backup folder. The current backup folder is in:
```
Jingtian_OneDrive/p4ServerRootBackup/
```
Multiple backups should be inside, with the backup date written in the directory name:
<img src=../Assets/serverBackupLocation.png>

## How to rebuild the server from the backup files:

To recreate the Server, download the files from the OneDrive backup folder

* First, delete all the db.* files, those can be regenerated by the ```checkpoint``` file. If they do not exists, nothing needs to be done.

* Open the terminal at the downloaded backup folder. type in command 

```
p4d -r . -jr ./checkpoint.[checkpoint number]
```
the ```checkpoint number``` will be different every time, look at the files in the folder, and you should find a file named ```checkpoint.``` with a number after the ```.```, if the file name is ```checkpoint.3```, then your console command will be:

```
p4d -r . -jr ./checkpoint.3
```
This will rebuild the ```db*``` files needed for the server to know the history and files.

If this error appear:
```
case handling mismatch: server uses Unix-style (-C0) but journal flags are Windows-style(-C1)!
```

then do:
```sh
p4d -r . -jr  -C1 checkpoint.3
```

* Install the license. move the license file to your perforce server root dir:
``` 
mv /path/to/license /p4root/license
```

* Ensure the correct file ownership and permission of the license:
```
chown perforce:perforce /p4root/license
chmod 644 /p4root/license
```

* Start the server:
``` 
p4d -r . -d
```

* If the depots are missing, recreate them should make them reappear.

```
p4 depot mgd_seniorthesis2024
```
be sure to configure the depot to use the same type. (local, stream, etc) and have the corrent Map (Map: /mgd/mgd_seniorthesis2024/)

You can use ```p4 info``` now to test if the server is up and runing.

Without a license, the server will not work properly, especially when over the user limit, which could be the case if the server backed up has more than 5 users.

To test the server without breaking the limit, we can backup the following files:
```sh
cp db.user db.user.bak
cp db.group db.group.bak
cp db.protect db.protect.bak
cp db.domain db.domain.bak
```
then remove them
```sh
rm db.user db.group db.protect db.domain 
```
next, we will ned to upgrade the database:
```sh
p4d -r . -xu
```

then test launch the server again:
```sh
p4 -r . -p 1666
```

